<!DOCTYPE html>
<!-- Place ceci TOUT EN HAUT de CarteSousse.html, avant tout autre script ou contenu -->
<script>
(async function(){
  // Le SECRET doit être identique à celui utilisé dans index.html
  const SECRET = "une_phrase_secrete_peu_complexe"; // change si tu veux, doit être identique côté login
  const TOKEN_KEY = "site_token"; // clé storage
  const REDIRECT = "index.html"; // page d'accueil

  function bufToHex(buffer){
    return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2,'0')).join('');
  }
  async function sha256Hex(str){
    const enc = new TextEncoder();
    const b = await crypto.subtle.digest("SHA-256", enc.encode(str));
    return bufToHex(b);
  }

  try {
    const raw = localStorage.getItem(TOKEN_KEY);
    if(!raw){
      // pas de token => rediriger
      window.location.replace(REDIRECT);
      return;
    }

    // decode token (base64 JSON)
    let obj;
    try {
      obj = JSON.parse(atob(raw));
    } catch(e){
      localStorage.removeItem(TOKEN_KEY);
      window.location.replace(REDIRECT);
      return;
    }

    // structure attendue: { user, exp, sig }
    if(!obj.exp || !obj.sig){
      localStorage.removeItem(TOKEN_KEY);
      window.location.replace(REDIRECT);
      return;
    }

    // expiration
    if(Date.now() > obj.exp){
      localStorage.removeItem(TOKEN_KEY);
      window.location.replace(REDIRECT);
      return;
    }

    // vérifier signature
    const expectedSig = await sha256Hex(SECRET + "|" + obj.exp);
    if(expectedSig !== obj.sig){
      localStorage.removeItem(TOKEN_KEY);
      window.location.replace(REDIRECT);
      return;
    }

    // token valide -> on continue et laisse la page se charger
    // Optionnel : on peut actualiser l'expiration ici (refresh token) si tu veux
  } catch(err){
    // en cas d'erreur inattendue, supprimer token et rediriger
    console.error("Auth check error:", err);
    localStorage.removeItem(TOKEN_KEY);
    window.location.replace(REDIRECT);
  }
})();
</script>

<html><head><meta charset='utf-8' />
<title>Carte AGR</title>
<link rel='stylesheet' href='https://unpkg.com/leaflet/dist/leaflet.css' />
<link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css' />
<link rel='stylesheet' href='https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css' />
<style>
body{margin:0;font-family:sans-serif;}
#map{height:85vh;width:100%;}
.filters{display:flex;justify-content:center;flex-wrap:wrap;gap:8px;margin:10px;}
select{padding:3px;}
.bottom-filters{position:absolute;bottom:5px;left:50%;transform:translateX(-50%);background:#fff;padding:5px;border-radius:5px;}
</style></head><body>
<div class='filters'>
<select id='deleg'><option value=''>-- Délégation --</option></select>
<select id='sect'><option value=''>-- Secteur --</option></select>
<select id='micro'><option value=''>-- Microzone --</option></select>
<select id='agr'><option value=''>-- AGR --</option></select>
</div>
<div id='map'></div>
<div class='bottom-filters'>
<select id='genre'><option value=''>-- Genre --</option><option>Homme</option><option>Femme</option></select>
<select id='age'><option value=''>-- Age --</option><option value='0'>Age</option><option value='1'>Jeune</option></select>
</div>
<script src='https://unpkg.com/leaflet/dist/leaflet.js'></script>
<script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
<script src='https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js'></script>
<script>
var map=L.map('map').setView([34,9],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: 'Powered by <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" style="width:20px;height:14px;vertical-align:middle;margin-right:4px;"> ING ABBASSI BRAHIM'}).addTo(map);
var mc=L.markerClusterGroup(),all=[];
e:'1'});






if(mc.getLayers().length>0)map.fitBounds(mc.getBounds());
function fillSelect(sel,set){sel.innerHTML='<option value="">--Tous--</option>';set.forEach(v=>{let o=document.createElement('option');o.text=v;o.value=v;sel.appendChild(o);});}
var dels=new Set(),agrs=new Set(),genres=new Set(),ages=new Set();
all.forEach(x=>{dels.add(x.d);agrs.add(x.a);genres.add(x.g);ages.add(x.age=='1'?'Age':'Jeune');});
fillSelect(deleg,dels);
fillSelect(agr,agrs);
fillSelect(genre,genres);
fillSelect(age,new Set(['Jeune','Age']));
function fillSect(d){sect.innerHTML='<option value="">--Tous--</option>';let S=new Set();all.forEach(x=>{if(!d||x.d==d)S.add(x.s)});S.forEach(v=>{let o=document.createElement('option');o.text=v;o.value=v;sect.appendChild(o);});fillMicro(d,null);}
function fillMicro(d,s){micro.innerHTML='<option value="">--Toutes--</option>';let M=new Set();all.forEach(x=>{if((!d||x.d==d)&&(!s||x.s==s))M.add(x.m)});M.forEach(v=>{let o=document.createElement('option');o.text=v;o.value=v;micro.appendChild(o);});}
function upd(){let d=deleg.value,s=sect.value,m=micro.value,a=agr.value,g=genre.value,aj=age.value;mc.clearLayers();all.forEach(x=>{let ageTxt=(x.age=='0'?'Age':'Jeune');if((!d||x.d==d)&&(!s||x.s==s)&&(!m||x.m==m)&&(!a||x.a==a)&&(!g||x.g==g)&&(!aj||ageTxt==aj))mc.addLayer(x.mk);});if(mc.getLayers().length>0)map.fitBounds(mc.getBounds());}
deleg.onchange=function(){fillSect(this.value);upd();};
sect.onchange=function(){fillMicro(deleg.value,this.value);upd();};
micro.onchange=upd;agr.onchange=upd;genre.onchange=upd;age.onchange=upd;
var stats=document.createElement('div');
stats.id='stats';stats.style.position='absolute';
stats.style.bottom='10px';stats.style.right='10px';
stats.style.background='rgba(255,255,255,0.9)';
stats.style.padding='8px';stats.style.borderRadius='6px';stats.style.fontSize='13px';
stats.innerHTML='Statistiques : 0 point';document.body.appendChild(stats);
function updateStats(){
let count=mc.getLayers().length,jeunes=0,ages=0,hommes=0,femmes=0;
all.forEach(x=>{
if(mc.hasLayer(x.mk)){
if(x.age=='0')jeunes++;else ages++;
if((x.g||'').toLowerCase()=='homme')hommes++;else femmes++;
}});
stats.innerHTML='Points affichés : '+count+'<br>Jeunes : '+jeunes+', Ages : '+ages+'<br>Hommes : '+hommes+', Femmes : '+femmes;}
function upd(){
let d=deleg.value,s=sect.value,m=micro.value,a=agr.value,g=genre.value,aj=age.value;
mc.clearLayers();
all.forEach(x=>{let ageTxt=(x.age=='0'?'Jeune':'Age');
if((!d||x.d==d)&&(!s||x.s==s)&&(!m||x.m==m)&&(!a||x.a==a)&&(!g||x.g==g)&&(!aj||ageTxt==aj))mc.addLayer(x.mk);});
if(mc.getLayers().length>0)map.fitBounds(mc.getBounds());updateStats();}
</script></body></html>


