<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Carte AGR - Sousse</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
}
#map {
  height: 85vh;
  width: 100%;
}
.filters {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px;
  margin: 10px;
}
select {
  padding: 5px;
  font-size: 14px;
}
.bottom-filters {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: #fff;
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.logout {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
}
.logout:hover {
  background: #d32f2f;
}
</style>
</head>

<body>

<!-- ✅ Vérification du token avant affichage -->
<script>
(async () => {
  const TOKEN_KEY = "site_token";
  const SECRET = "cle_privee_ultra_simple";

  async function sha256Hex(str) {
    const enc = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(x => x.toString(16).padStart(2,"0")).join("");
  }

  const data = localStorage.getItem(TOKEN_KEY);
  if (!data) {
    window.location.href = "index.html";
    return;
  }

  try {
    const token = JSON.parse(atob(data));
    const sig = await sha256Hex(SECRET + "|" + token.exp);
    if (token.sig !== sig || Date.now() > token.exp) {
      localStorage.removeItem(TOKEN_KEY);
      window.location.href = "index.html";
    }
  } catch (e) {
    localStorage.removeItem(TOKEN_KEY);
    window.location.href = "index.html";
  }
})();
</script>

<!-- Filtres -->
<div class="filters">
  <select id="deleg"><option value="">-- Délégation --</option></select>
  <select id="sect"><option value="">-- Secteur --</option></select>
  <select id="micro"><option value="">-- Microzone --</option></select>
  <select id="agr"><option value="">-- AGR --</option></select>
</div>

<!-- Carte -->
<div id="map"></div>

<!-- Filtres du bas -->
<div class="bottom-filters">
  <select id="genre">
    <option value="">-- Genre --</option>
    <option>Homme</option>
    <option>Femme</option>
  </select>
  <select id="age">
    <option value="">-- Âge --</option>
    <option value="0">Jeune</option>
    <option value="1">Âgé</option>
  </select>
</div>

<!-- Bouton de déconnexion -->
<button class="logout" onclick="logout()">Déconnexion</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// === Initialisation de la carte ===
var map = L.map('map').setView([35.83, 10.64], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Powered by <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" style="width:20px;height:14px;vertical-align:middle;margin-right:4px;"> Ing. ABBASSI BRAHIM'
}).addTo(map);

// === Pas de markers pour le moment ===
var mc = L.markerClusterGroup();
map.addLayer(mc);

// === Initialisation vide des filtres ===
function fillSelect(sel, options) {
  sel.innerHTML = '<option value="">-- Tous --</option>';
  options.forEach(v => {
    let o = document.createElement('option');
    o.text = v; o.value = v;
    sel.appendChild(o);
  });
}

fillSelect(document.getElementById('deleg'), new Set());
fillSelect(document.getElementById('sect'), new Set());
fillSelect(document.getElementById('micro'), new Set());
fillSelect(document.getElementById('agr'), new Set());

// === Fonction de déconnexion ===
function logout() {
  localStorage.removeItem("site_token");
  window.location.href = "index.html";
}
</script>

</body>
</html>
