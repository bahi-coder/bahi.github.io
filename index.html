<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Carte des b√©n√©ficiaires - Sousse</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #4CAF50, #2196F3);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
  }
  .container {
    text-align: center;
    background: rgba(0,0,0,0.45);
    padding: 36px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    width: 320px;
  }
  h1 { font-size: 20px; margin-bottom: 12px; }
  p { font-size: 14px; margin-bottom: 18px; color: #f0f7ff; }
  input {
    padding: 10px;
    border-radius: 8px;
    border: none;
    width: 100%;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
  button {
    background: #ffeb3b;
    color: #333;
    font-size: 16px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
  }
  .msg { margin-top: 10px; color: #ffe082; font-size: 13px; min-height: 18px; }
  .small { font-size: 12px; color: rgba(255,255,255,0.8); margin-top:8px; }
</style>
</head>
<body>
  <div class="container">
    <h1>Programme d‚Äôaccompagnement ‚Äî Sousse</h1>
    <p>Acc√®s r√©serv√©. Entrez le mot de passe pour afficher la carte interactive.</p>

    <input id="pass" type="password" placeholder="Mot de passe" autocomplete="off" />
    <button id="goBtn">üåç Voir la carte</button>

    <div id="msg" class="msg"></div>
    <div class="small">Protection l√©g√®re : utile pour emp√™cher les curieux. Pour une s√©curit√© totale, il faudrait une authentification c√¥t√© serveur.</div>
  </div>

<script>


// hash attendu (hex) ‚Äî NE PAS mettre le mot de passe en clair ici.
const EXPECTED_HASH = "b97649803596ed3f11b1a9d7e5cda20a71d198f96f003da6afbd36f92354a62a";

// param√®tres limite
const MAX_ATTEMPTS = 5;
const LOCK_MINUTES = 5; // dur√©e du blocage apr√®s trop d'√©checs

const passInput = document.getElementById("pass");
const goBtn = document.getElementById("goBtn");
const msgDiv = document.getElementById("msg");

function nowMs(){ return Date.now(); }

function getState(){
  const raw = localStorage.getItem("auth_state");
  if(!raw) return { attempts: 0, lockedUntil: 0 };
  try { return JSON.parse(raw); } catch(e){ return { attempts:0, lockedUntil:0 }; }
}
function saveState(st){ localStorage.setItem("auth_state", JSON.stringify(st)); }

// convertir ArrayBuffer -> hex string
function bufToHex(buffer){
  const bytes = new Uint8Array(buffer);
  const hex = Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
  return hex;
}

// calcule SHA-256 d'une cha√Æne (UTF-8) et retourne hex string
async function sha256Hex(str){
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  return bufToHex(hashBuffer);
}

function setMessage(text, danger){
  msgDiv.textContent = text || "";
  msgDiv.style.color = danger ? "#ffb3b3" : "#ffe082";
}

// v√©rifie le verrouillage et affiche temps restant
function checkLock(){
  const st = getState();
  if(st.lockedUntil && st.lockedUntil > nowMs()){
    const sec = Math.ceil((st.lockedUntil - nowMs())/1000);
    setMessage(`Trop de tentatives. R√©essayez dans ${sec} s.`, true);
    return true;
  } else {
    // si verrou expir√©, reset attempts
    if(st.lockedUntil && st.lockedUntil <= nowMs()){
      saveState({ attempts: 0, lockedUntil: 0 });
    }
    return false;
  }
}

goBtn.addEventListener("click", async function(){
  // d√©sactiver r√©p√©tition rapide
  goBtn.disabled = true;
  setTimeout(()=> goBtn.disabled = false, 800);

  if(checkLock()) return;

  const plain = passInput.value || "";
  if(plain.trim() === ""){
    setMessage("Entrez le mot de passe.", true);
    return;
  }

  try {
    const hash = await sha256Hex(plain);
    if(hash === EXPECTED_HASH){
      // succ√®s : reset √©tat et redirection
      saveState({ attempts: 0, lockedUntil: 0 });
      window.location.href = "CarteSousse.html";
    } else {
      // √©chec : incr√©menter tentatives
      const st = getState();
      st.attempts = (st.attempts || 0) + 1;
      if(st.attempts >= MAX_ATTEMPTS){
        st.lockedUntil = nowMs() + LOCK_MINUTES * 60 * 1000;
        setMessage(`Mot de passe incorrect. Verrouillage ${LOCK_MINUTES} minutes.`, true);
      } else {
        const rest = MAX_ATTEMPTS - st.attempts;
        setMessage(`Mot de passe incorrect. ${rest} tentative(s) restante(s).`, true);
      }
      saveState(st);
    }
  } catch (err){
    console.error(err);
    setMessage("Erreur interne. R√©essayez.", true);
  }
});
</script>
</body>
</html>
