<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connexion ‚Äî Carte Sousse</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #4CAF50, #2196F3);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .box {
      background: rgba(0,0,0,0.45);
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      width: 340px;
      text-align: center;
    }
    h1 { margin: 0 0 10px 0; font-size: 20px; }
    p { margin: 0 0 16px 0; font-size: 14px; color: #f0f7ff; }
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #ffeb3b;
      color: #333;
      font-size: 16px;
      cursor: pointer;
    }
    .msg { margin-top: 12px; min-height: 18px; font-size: 13px; color: #ffe082; }
    .small { margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.8); }
  </style>
</head>
<body>
  <div class="box">
    <h1>IESS ‚Äî Kairouan</h1>
    <p>Acc√®s r√©serv√©. Entrez le mot de passe pour afficher la carte interactive.</p>

    <input id="pass" type="password" placeholder="Mot de passe" autocomplete="off" />
    <button id="goBtn">üåç Voir la carte</button>

    <div id="msg" class="msg"></div>
    <div class="small">
  Powered by Ing ABBASSI Ibrahim 
  <img src="https://upload.wikimedia.org/wikipedia/commons/c/ce/Flag_of_Tunisia.svg" 
       alt="Drapeau de la Tunisie" 
       style="width:22px; height:16px; margin-left:6px; vertical-align:middle;">
</div>

  </div>

  <script>
    /**************************************************************************
     * Configuration (modifie si besoin)
     *
     * - EXPECTED_HASH : SHA-256 hex du mot de passe choisi (exemple donn√© plus bas)
     * - SECRET        : phrase secr√®te utilis√©e pour signer le token (doit √™tre
     *                   identique dans CarteSousse.html)
     * - TOKEN_KEY     : cl√© utilis√©e dans localStorage
     **************************************************************************/

    const EXPECTED_HASH = "b97649803596ed3f11b1a9d7e5cda20a71d198f96f003da6afbd36f92354a62a";
    // EXPECTED_HASH correspond au SHA-256 du mot de passe "sousse2025".
    // Si tu changes le mot de passe, calcule le SHA-256 et remplace cette valeur.

    const SECRET = "une_phrase_secrete_peu_complexe"; // change si tu veux (m√™me valeur dans CarteSousse.html)
    const TOKEN_KEY = "site_token";

    const MAX_ATTEMPTS = 5;
    const LOCK_MINUTES = 5; // minutes de verrou apr√®s MAX_ATTEMPTS √©checs

    // utilitaires
    function bufToHex(buffer){
      return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2,'0')).join('');
    }
    async function sha256Hex(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      return bufToHex(hashBuffer);
    }

    function nowMs(){ return Date.now(); }

    function getState(){
      const raw = localStorage.getItem("auth_state");
      if(!raw) return { attempts: 0, lockedUntil: 0 };
      try { return JSON.parse(raw); } catch(e){ return { attempts:0, lockedUntil:0 }; }
    }
    function saveState(st){ localStorage.setItem("auth_state", JSON.stringify(st)); }

    function setMessage(text, danger){
      const msg = document.getElementById("msg");
      msg.textContent = text || "";
      if(danger) msg.style.color = "#ffb3b3"; else msg.style.color = "#ffe082";
    }

    function checkLock(){
      const st = getState();
      if(st.lockedUntil && st.lockedUntil > nowMs()){
        const sec = Math.ceil((st.lockedUntil - nowMs())/1000);
        setMessage(`Trop de tentatives. R√©essayez dans ${sec} s.`, true);
        return true;
      } else {
        if(st.lockedUntil && st.lockedUntil <= nowMs()){
          saveState({ attempts: 0, lockedUntil: 0 });
        }
        return false;
      }
    }

    // stocker token sign√© (base64 JSON)
    function saveToken(tokenObj){
      localStorage.setItem(TOKEN_KEY, btoa(JSON.stringify(tokenObj)));
    }

    // gestion du bouton
    document.getElementById("goBtn").addEventListener("click", async function(){
      const goBtn = document.getElementById("goBtn");
      const passInput = document.getElementById("pass");
      goBtn.disabled = true;
      setTimeout(()=> goBtn.disabled = false, 700);

      if(checkLock()) return;

      const plain = (passInput.value || "").trim();
      if(plain === ""){
        setMessage("‚ö†Ô∏è Veuillez entrer le mot de passe.", true);
        return;
      }

      try {
        // verifier hash du mot de passe
        const hash = await sha256Hex(plain);
        if(hash !== EXPECTED_HASH){
          // echec : incrementer tentatives
          const st = getState();
          st.attempts = (st.attempts || 0) + 1;
          if(st.attempts >= MAX_ATTEMPTS){
            st.lockedUntil = nowMs() + LOCK_MINUTES * 60 * 1000;
            setMessage(`Mot de passe incorrect. Verrouillage ${LOCK_MINUTES} minutes.`, true);
          } else {
            const rest = MAX_ATTEMPTS - st.attempts;
            setMessage(`Mot de passe incorrect. ${rest} tentative(s) restante(s).`, true);
          }
          saveState(st);
          return;
        }

        // mot de passe correct -> creer token signe
        const expireMs = Date.now() + 20 * 60 * 1000; // 20 minutes
        const sig = await sha256Hex(SECRET + "|" + expireMs);
        const tokenObj = { user: "admin", exp: expireMs, sig: sig };
        saveToken(tokenObj);

        // reinitialiser et rediriger
        saveState({ attempts: 0, lockedUntil: 0 });
        window.location.href = "CarteSousse.html";
      } catch (err){
        console.error(err);
        setMessage("Erreur interne. R√©essayez.", true);
      }
    });

    // Si tu veux, tu peux aussi permettre Enter pour soumettre
    document.getElementById("pass").addEventListener("keyup", function(e){
      if(e.key === "Enter"){ document.getElementById("goBtn").click(); }
    });
  </script>
</body>
</html>

